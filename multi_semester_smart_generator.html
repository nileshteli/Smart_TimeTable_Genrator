<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Semester Smart Timetable Generator</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        /* Workflow Steps */
        .workflow-container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
        }

        .workflow-steps {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            position: relative;
        }

        .workflow-steps::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 50px;
            right: 50px;
            height: 2px;
            background: #e2e8f0;
            z-index: 1;
        }

        .workflow-step {
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            z-index: 2;
            background: white;
            padding: 10px;
            border-radius: 10px;
        }

        .step-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #718096;
            margin-bottom: 10px;
            transition: all 0.3s ease;
        }

        .step-circle.active {
            background: #4299e1;
            color: white;
        }

        .step-circle.completed {
            background: #48bb78;
            color: white;
        }

        .step-title {
            font-size: 0.9rem;
            font-weight: 600;
            text-align: center;
            color: #4a5568;
        }

        /* Main Content Area */
        .main-content {
            display: grid;
            grid-template-columns: 1fr;
            gap: 20px;
        }

        .content-section {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: none;
        }

        .content-section.active {
            display: block;
        }

        .section-title {
            font-size: 1.8rem;
            margin-bottom: 20px;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Multi-Semester Selection Styles */
        .semester-selection-container {
            margin-bottom: 25px;
        }

        .selection-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .control-btn {
            padding: 8px 15px;
            background: #4299e1;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            background: #3182ce;
        }

        .control-btn.secondary {
            background: #718096;
        }

        .control-btn.secondary:hover {
            background: #4a5568;
        }

        /* Course Groups */
        .course-group {
            margin-bottom: 25px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            overflow: hidden;
        }

        .course-group-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 1.1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .course-group-header:hover {
            background: linear-gradient(135deg, #5a67d8 0%, #6b46c1 100%);
        }

        .course-group-content {
            padding: 20px;
            background: #f7fafc;
        }

        .course-group-content.collapsed {
            display: none;
        }

        .semester-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
        }

        .semester-checkbox-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .semester-checkbox-card:hover {
            border-color: #4299e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.15);
        }

        .semester-checkbox-card.selected {
            border-color: #48bb78;
            background: #f0fff4;
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.15);
        }

        .semester-checkbox {
            display: flex;
            align-items: flex-start;
            gap: 12px;
        }

        .semester-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-top: 2px;
            cursor: pointer;
        }

        .semester-info {
            flex: 1;
        }

        .semester-name {
            font-weight: 600;
            color: #2d3748;
            font-size: 1rem;
            margin-bottom: 5px;
        }

        .semester-details {
            font-size: 0.85rem;
            color: #718096;
            margin-bottom: 8px;
        }

        .semester-meta {
            display: flex;
            gap: 15px;
            font-size: 0.8rem;
            color: #4a5568;
        }

        .semester-meta span {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        /* Selection Summary */
        .selection-summary {
            background: #e6fffa;
            border: 2px solid #38b2ac;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
        }

        .selection-summary.hidden {
            display: none;
        }

        .summary-header {
            font-weight: 600;
            color: #2c7a7b;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .selected-semesters-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 10px;
        }

        .selected-semester-item {
            background: white;
            padding: 10px;
            border-radius: 6px;
            border-left: 4px solid #38b2ac;
            font-size: 0.9rem;
        }

        .selected-semester-name {
            font-weight: 600;
            color: #2d3748;
        }

        .selected-semester-details {
            color: #718096;
            font-size: 0.8rem;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #2d3748;
            font-size: 1rem;
        }

        /* Buttons */
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #718096;
        }

        .btn-success {
            background: #48bb78;
        }

        .button-group {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        /* Status Messages */
        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 0.95rem;
            display: none;
        }

        .status-message.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
            display: block;
        }

        .status-message.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
            display: block;
        }

        .status-message.warning {
            background: #fefcbf;
            color: #744210;
            border: 1px solid #f6e05e;
            display: block;
        }

        /* Loading Animation */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
            color: #4a5568;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            border: 4px solid #e2e8f0;
            border-top: 4px solid #4299e1;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .workflow-steps {
                flex-direction: column;
                gap: 20px;
            }

            .workflow-steps::before {
                display: none;
            }

            .semester-grid {
                grid-template-columns: 1fr;
            }

            .selection-controls {
                flex-direction: column;
            }

            .button-group {
                flex-direction: column;
            }

            .selected-semesters-list {
                grid-template-columns: 1fr;
            }
        }

        /* Faculty Workload Summary Styles */
        .faculty-workload-summary {
            background: #f0f8ff;
            border: 2px solid #4299e1;
            border-radius: 10px;
            padding: 20px;
            margin-top: 15px;
        }

        .faculty-workload-summary h4 {
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .faculty-workload-summary table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .faculty-workload-summary th {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white;
            padding: 12px 8px;
            border: 1px solid #e2e8f0;
            font-weight: 600;
        }

        .faculty-workload-summary td {
            padding: 10px 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
        }

        .faculty-workload-summary .faculty-name {
            text-align: left;
            font-weight: 600;
        }

        .faculty-workload-summary .over-limit {
            background: #fc8181;
            color: white;
            font-weight: bold;
        }

        .faculty-workload-summary .high-load {
            background: #fbb6ce;
            color: #742a2a;
        }

        .faculty-workload-summary .violation-row {
            background: #fed7d7;
        }

        .faculty-workload-summary .normal-row {
            background: #f7fafc;
        }

        .workload-legend {
            margin-top: 15px;
            font-size: 0.9rem;
            color: #4a5568;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            align-items: center;
        }

        .workload-legend span {
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .legend-over {
            background: #fc8181;
            color: white;
        }

        .legend-high {
            background: #fbb6ce;
            color: #742a2a;
        }

        .legend-normal {
            background: #f7fafc;
            color: #4a5568;
            border: 1px solid #e2e8f0;
        }

        /* Working Hours Configuration Styles */
        .working-hours-container {
            background: #f7fafc;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #e2e8f0;
        }

        .working-hours-info {
            margin-bottom: 25px;
        }

        .working-hours-form {
            margin-bottom: 30px;
        }

        .time-inputs {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .time-input-group {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
            text-align: center;
            transition: all 0.3s ease;
        }

        .time-input-group:hover {
            border-color: #4299e1;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(66, 153, 225, 0.15);
        }

        .time-input-group label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 10px;
            font-size: 1rem;
        }

        .time-input-group input[type="time"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            text-align: center;
            color: #2d3748;
            background: #f7fafc;
            transition: all 0.3s ease;
        }

        .time-input-group input[type="time"]:focus {
            outline: none;
            border-color: #4299e1;
            background: white;
            box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1);
        }

        .time-input-group small {
            display: block;
            color: #718096;
            font-size: 0.85rem;
            margin-top: 8px;
        }

        .preset-buttons {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }

        .preset-buttons h4 {
            color: #2d3748;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .preset-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 10px;
        }

        .working-hours-preview {
            background: white;
            padding: 25px;
            border-radius: 10px;
            border: 2px solid #e2e8f0;
        }

        .working-hours-preview h4 {
            color: #2d3748;
            margin-bottom: 20px;
            font-size: 1.1rem;
        }

        .time-slots-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
        }

        .time-slot-item {
            background: #e6fffa;
            border: 2px solid #38b2ac;
            border-radius: 8px;
            padding: 12px 8px;
            text-align: center;
            font-weight: 600;
            color: #2c7a7b;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }

        .time-slot-item:hover {
            background: #b2f5ea;
            transform: translateY(-2px);
        }

        .time-slot-item.lunch {
            background: #fff5f5;
            border-color: #fc8181;
            color: #742a2a;
        }

        .time-slot-item.lunch:hover {
            background: #fed7d7;
        }

        .working-hours-summary {
            background: #f0f8ff;
            border: 2px solid #4299e1;
            border-radius: 8px;
            padding: 20px;
        }

        .working-hours-summary h5 {
            color: #2c5282;
            margin-bottom: 15px;
            font-size: 1rem;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .summary-stat {
            text-align: center;
        }

        .summary-stat .stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3182ce;
            display: block;
        }

        .summary-stat .stat-label {
            font-size: 0.85rem;
            color: #4a5568;
            margin-top: 5px;
        }

        /* Responsive table styles for Saturday support */
        .timetable-container {
            overflow-x: auto;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .timetable-table {
            width: 100%;
            min-width: 900px; /* Minimum width to accommodate 6 days + time column */
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .timetable-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 12px 8px;
            border: 1px solid #e2e8f0;
            font-weight: 600;
            text-align: center;
            min-width: 120px;
        }

        .timetable-table th:first-child {
            min-width: 100px; /* Time column */
        }

        .timetable-table td {
            padding: 12px 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
            vertical-align: middle;
            min-width: 120px;
        }

        .timetable-table td:first-child {
            background: #4a5568;
            color: white;
            font-weight: 600;
            min-width: 100px;
        }

        /* Mobile responsiveness */
        @media (max-width: 768px) {
            .timetable-table {
                min-width: 1000px; /* Ensure horizontal scroll on mobile */
                font-size: 0.9rem;
            }
            
            .timetable-table th,
            .timetable-table td {
                padding: 8px 6px;
                min-width: 100px;
            }
            
            .timetable-table th:first-child,
            .timetable-table td:first-child {
                min-width: 80px;
            }
        }

        /* Timetable card improvements for Saturday */
        .timetable-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid #e2e8f0;
            transition: all 0.3s ease;
        }

        .timetable-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: #4299e1;
        }

        /* Saturday-specific styling */
        .saturday-column {
            background: linear-gradient(135deg, #805ad5 0%, #9f7aea 100%) !important;
        }

        .saturday-cell {
            background: #f7fafc !important;
            border-left: 4px solid #805ad5 !important;
        }

        /* Improved table responsiveness */
        .content-section {
            overflow-x: visible;
        }

        .timetable-preview-container {
            width: 100%;
            overflow-x: auto;
            padding: 10px 0;
        }

        /* Fix for table layout issues */
        .timetable-table tbody tr:hover {
            background-color: rgba(66, 153, 225, 0.05);
        }

        .timetable-table tbody tr:hover td:first-child {
            background-color: #4a5568 !important;
        }

        /* Timetable Preview Styles */
        .timetable-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            margin: 20px 0;
            overflow: hidden;
        }

        .timetable-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .timetable-header h3 {
            margin: 0;
            font-size: 1.4rem;
        }

        .timetable-actions {
            display: flex;
            gap: 10px;
        }

        .timetable-actions .btn {
            padding: 8px 16px;
            font-size: 0.9rem;
        }

        .timetable-container {
            padding: 20px;
            overflow-x: auto;
        }

        .timetable-table {
            width: 100%;
            min-width: 900px;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .timetable-table th {
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            color: white;
            padding: 15px 10px;
            text-align: center;
            font-weight: 600;
            border: 1px solid #e2e8f0;
        }

        .timetable-table td {
            padding: 12px 8px;
            border: 1px solid #e2e8f0;
            text-align: center;
            vertical-align: middle;
            min-height: 60px;
        }

        .time-slot {
            background: #f7fafc;
            font-weight: 600;
            color: #4a5568;
            min-width: 100px;
        }

        .class-cell {
            background: #e6fffa;
            border-left: 4px solid #38b2ac;
            padding: 8px;
            position: relative;
        }

        .class-cell.theory {
            background: #ebf8ff;
            border-left-color: #4299e1;
        }

        .class-cell.lab {
            background: #fef5e7;
            border-left-color: #ed8936;
        }

        .class-cell.practical {
            background: #f0fff4;
            border-left-color: #48bb78;
        }

        .subject-code {
            font-weight: bold;
            font-size: 0.9rem;
            color: #2d3748;
            margin-bottom: 2px;
        }

        .subject-name {
            font-size: 0.8rem;
            color: #4a5568;
            margin-bottom: 2px;
        }

        .faculty-info {
            font-size: 0.75rem;
            color: #718096;
            margin-bottom: 2px;
        }

        .room-info {
            font-size: 0.75rem;
            color: #718096;
            margin-bottom: 2px;
        }

        .lecture-type {
            font-size: 0.7rem;
            background: #4299e1;
            color: white;
            padding: 2px 6px;
            border-radius: 3px;
            display: inline-block;
            margin-top: 2px;
        }

        .class-cell.lab .lecture-type {
            background: #ed8936;
        }

        .class-cell.practical .lecture-type {
            background: #48bb78;
        }

        .lunch-cell {
            background: #fff5f5;
            color: #742a2a;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .empty-cell {
            background: #fafafa;
            height: 60px;
        }

        /* Responsive design for timetable */
        @media (max-width: 768px) {
            .timetable-container {
                padding: 10px;
            }
            
            .timetable-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .timetable-actions {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1><i class="fas fa-graduation-cap"></i> Multi-Semester Smart Timetable Generator</h1>
            <p>Create coordinated timetables across multiple semesters with advanced conflict detection</p>
        </div>

        <!-- Workflow Steps -->
        <div class="workflow-container">
            <div class="workflow-steps">
                <div class="workflow-step">
                    <div class="step-circle active" id="step0Circle">0</div>
                    <div class="step-title">Working Hours</div>
                </div>
                <div class="workflow-step">
                    <div class="step-circle" id="step1Circle">1</div>
                    <div class="step-title">Select Semester(s)</div>
                </div>
                <div class="workflow-step">
                    <div class="step-circle" id="step2Circle">2</div>
                    <div class="step-title">Configure Sections</div>
                </div>
                <div class="workflow-step">
                    <div class="step-circle" id="step3Circle">3</div>
                    <div class="step-title">Enter Lecture Details</div>
                </div>
                <div class="workflow-step">
                    <div class="step-circle" id="step4Circle">4</div>
                    <div class="step-title">Generate Timetables</div>
                </div>
                <div class="workflow-step">
                    <div class="step-circle" id="step5Circle">5</div>
                    <div class="step-title">Preview & Save</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <!-- Step 0: College Working Hours Configuration -->
            <div class="content-section active" id="step0">
                <h2 class="section-title">
                    <i class="fas fa-clock"></i>
                    College Working Hours Configuration
                </h2>
                
                <div class="working-hours-container">
                    <div class="working-hours-info">
                        <p style="color: #4a5568; margin-bottom: 20px;">
                            <i class="fas fa-info-circle"></i>
                            Configure the college working hours to generate timetable slots within your institution's schedule.
                        </p>
                    </div>

                    <div class="working-hours-form">
                        <div class="time-inputs">
                            <div class="time-input-group">
                                <label for="startTime">
                                    <i class="fas fa-play"></i> Start Time
                                </label>
                                <input type="time" id="startTime" value="09:00" onchange="updateWorkingHours()">
                                <small>College starts at</small>
                            </div>
                            
                            <div class="time-input-group">
                                <label for="endTime">
                                    <i class="fas fa-stop"></i> End Time
                                </label>
                                <input type="time" id="endTime" value="17:00" onchange="updateWorkingHours()">
                                <small>College ends at</small>
                            </div>
                            
                            <div class="time-input-group">
                                <label for="lunchStart">
                                    <i class="fas fa-utensils"></i> Lunch Start
                                </label>
                                <input type="time" id="lunchStart" value="12:00" onchange="updateWorkingHours()">
                                <small>Lunch break starts</small>
                            </div>
                            
                            <div class="time-input-group">
                                <label for="lunchEnd">
                                    <i class="fas fa-utensils"></i> Lunch End
                                </label>
                                <input type="time" id="lunchEnd" value="13:00" onchange="updateWorkingHours()">
                                <small>Lunch break ends</small>
                            </div>
                        </div>

                        <div class="preset-buttons">
                            <h4>Quick Presets:</h4>
                            <div class="preset-options">
                                <button class="control-btn" onclick="setPreset('standard')">
                                    <i class="fas fa-clock"></i> Standard (9 AM - 5 PM)
                                </button>
                                <button class="control-btn" onclick="setPreset('morning')">
                                    <i class="fas fa-sun"></i> Morning Shift (8 AM - 4 PM)
                                </button>
                                <button class="control-btn" onclick="setPreset('extended')">
                                    <i class="fas fa-clock"></i> Extended (8 AM - 6 PM)
                                </button>
                                <button class="control-btn secondary" onclick="setPreset('custom')">
                                    <i class="fas fa-cog"></i> Custom Hours
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="working-hours-preview">
                        <h4><i class="fas fa-eye"></i> Generated Time Slots Preview:</h4>
                        <div class="time-slots-preview" id="timeSlotsPreview">
                            <!-- Time slots will be populated here -->
                        </div>
                        
                        <div class="working-hours-summary" id="workingHoursSummary">
                            <!-- Summary will be populated here -->
                        </div>
                    </div>
                </div>

                <div class="status-message" id="workingHoursStatus"></div>

                <div class="button-group">
                    <button class="btn" onclick="proceedToSemesterSelection()" id="proceedToSemesterSelectionBtn">
                        <i class="fas fa-arrow-right"></i>
                        Proceed to Semester Selection
                    </button>
                </div>
            </div>

            <!-- Step 1: Select Multiple Semesters -->
            <div class="content-section" id="step1">
                <h2 class="section-title">
                    <i class="fas fa-calendar-check"></i>
                    Which semester(s) timetable do you want to create?
                </h2>
                
                <div class="semester-selection-container">
                    <!-- Selection Controls -->
                    <div class="selection-controls">
                        <button class="control-btn" onclick="selectAllSemesters()">
                            <i class="fas fa-check-double"></i> Select All
                        </button>
                        <button class="control-btn secondary" onclick="clearAllSemesters()">
                            <i class="fas fa-times"></i> Clear All
                        </button>
                        <button class="control-btn" onclick="selectByCourse('B.Tech')">
                            <i class="fas fa-graduation-cap"></i> All B.Tech
                        </button>
                        <button class="control-btn" onclick="selectByCourse('M.Tech')">
                            <i class="fas fa-user-graduate"></i> All M.Tech
                        </button>
                        <button class="control-btn" onclick="selectByCourse('MBA')">
                            <i class="fas fa-briefcase"></i> All MBA
                        </button>
                        <button class="control-btn" onclick="selectByCourse('BCA')">
                            <i class="fas fa-laptop-code"></i> All BCA
                        </button>
                    </div>

                    <!-- Course Groups -->
                    <div id="courseGroups">
                        <!-- Course groups will be populated here -->
                    </div>

                    <!-- Selection Summary -->
                    <div class="selection-summary hidden" id="selectionSummary">
                        <div class="summary-header">
                            <i class="fas fa-list-check"></i> Selected Semesters (<span id="selectedCount">0</span>)
                        </div>
                        <div class="selected-semesters-list" id="selectedSemestersList">
                            <!-- Selected semesters will appear here -->
                        </div>
                    </div>
                </div>

                <div class="status-message" id="semesterStatus"></div>

                <div class="button-group">
                    <button class="btn" onclick="proceedToSectionConfiguration()" id="proceedToSectionBtn" disabled>
                        <i class="fas fa-arrow-right"></i>
                        Proceed to Section Configuration
                    </button>
                </div>
            </div>

            <!-- Step 2: Configure Sections -->
            <div class="content-section" id="step2">
                <h2 class="section-title">
                    <i class="fas fa-users-cog"></i>
                    Configure Sections for Selected Semesters
                </h2>

                <div id="sectionConfiguration">
                    <!-- Section configuration will be populated here -->
                </div>

                <div class="status-message" id="sectionStatus"></div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="goBackToStep(0)">
                        <i class="fas fa-arrow-left"></i>
                        Back to Working Hours
                    </button>
                    <button class="btn" onclick="proceedToLectureDetails()" id="proceedToLectureBtn" disabled>
                        <i class="fas fa-arrow-right"></i>
                        Proceed to Lecture Details
                    </button>
                </div>
            </div>

            <!-- Step 3: Enter Lecture Details -->
            <div class="content-section" id="step3">
                <h2 class="section-title">
                    <i class="fas fa-chalkboard-teacher"></i>
                    Enter Lecture Details for All Selected Semesters
                </h2>

                <div id="lectureConfiguration">
                    <!-- Lecture configuration will be populated here -->
                </div>

                <div class="status-message" id="lectureStatus"></div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="goBackToStep(2)">
                        <i class="fas fa-arrow-left"></i>
                        Back to Section Configuration
                    </button>
                    <button class="btn" onclick="proceedToGeneration()" id="proceedToGenerationBtn">
                        <i class="fas fa-arrow-right"></i>
                        Generate All Timetables
                    </button>
                </div>
            </div>

            <!-- Step 4: Generate Timetables -->
            <div class="content-section" id="step4">
                <h2 class="section-title">
                    <i class="fas fa-cogs"></i>
                    Generating Multi-Semester Timetables
                </h2>

                <div class="loading" id="loading">
                    <div class="spinner"></div>
                    <p>Generating timetables for all selected semesters...</p>
                    <p><small>Checking for faculty conflicts across semesters</small></p>
                </div>

                <div id="generationResults"></div>

                <div class="button-group" id="generationButtons" style="display: none;">
                    <button class="btn btn-secondary" onclick="goBackToStep(3)">
                        <i class="fas fa-arrow-left"></i>
                        Back to Lecture Details
                    </button>
                    <button class="btn" onclick="proceedToPreview()" id="proceedToPreviewBtn">
                        <i class="fas fa-arrow-right"></i>
                        Preview All Timetables
                    </button>
                </div>
            </div>

            <!-- Step 5: Preview & Save -->
            <div class="content-section" id="step5">
                <h2 class="section-title">
                    <i class="fas fa-eye"></i>
                    Preview & Save Multi-Semester Timetables
                </h2>

                <div id="timetablePreview">
                    <!-- Generated timetables will be displayed here -->
                </div>

                <div class="status-message" id="previewStatus"></div>

                <div class="button-group">
                    <button class="btn btn-secondary" onclick="goBackToStep(4)">
                        <i class="fas fa-arrow-left"></i>
                        Back to Generation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentStep = 0; // Start with working hours step
        let selectedSemesters = [];
        let sectionConfigurations = {};
        let lectureConfigurations = {};
        let generatedTimetables = {};
        let collegeWorkingHours = {
            startTime: '09:00',
            endTime: '17:00',
            lunchStart: '12:00',
            lunchEnd: '13:00'
        };
        let timeSlots = []; // Will be generated based on working hours
        let days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeWorkingHours();
        });

        // Working Hours Configuration Functions
        function initializeWorkingHours() {
            updateWorkingHours();
        }

        function updateWorkingHours() {
            // Get values from inputs
            collegeWorkingHours.startTime = document.getElementById('startTime').value;
            collegeWorkingHours.endTime = document.getElementById('endTime').value;
            collegeWorkingHours.lunchStart = document.getElementById('lunchStart').value;
            collegeWorkingHours.lunchEnd = document.getElementById('lunchEnd').value;

            // Validate times
            if (!validateWorkingHours()) {
                return;
            }

            // Generate time slots
            generateTimeSlots();
            
            // Update preview
            updateTimeSlotsPreview();
            
            // Update summary
            updateWorkingHoursSummary();
            
            // Show success status
            showStatus('workingHoursStatus', 'Working hours configured successfully!', 'success');
        }

        function validateWorkingHours() {
            const start = timeToMinutes(collegeWorkingHours.startTime);
            const end = timeToMinutes(collegeWorkingHours.endTime);
            const lunchStart = timeToMinutes(collegeWorkingHours.lunchStart);
            const lunchEnd = timeToMinutes(collegeWorkingHours.lunchEnd);

            if (start >= end) {
                showStatus('workingHoursStatus', 'End time must be after start time!', 'error');
                return false;
            }

            if (lunchStart >= lunchEnd) {
                showStatus('workingHoursStatus', 'Lunch end time must be after lunch start time!', 'error');
                return false;
            }

            if (lunchStart < start || lunchEnd > end) {
                showStatus('workingHoursStatus', 'Lunch break must be within college working hours!', 'error');
                return false;
            }

            return true;
        }

        function generateTimeSlots() {
            timeSlots = [];
            
            const startMinutes = timeToMinutes(collegeWorkingHours.startTime);
            const endMinutes = timeToMinutes(collegeWorkingHours.endTime);
            const lunchStartMinutes = timeToMinutes(collegeWorkingHours.lunchStart);
            const lunchEndMinutes = timeToMinutes(collegeWorkingHours.lunchEnd);
            
            // Generate 1-hour slots
            for (let minutes = startMinutes; minutes < endMinutes; minutes += 60) {
                const slotStart = minutesToTime(minutes);
                const slotEnd = minutesToTime(minutes + 60);
                
                // Check if this slot overlaps with lunch break
                const slotStartMinutes = minutes;
                const slotEndMinutes = minutes + 60;
                
                if (slotStartMinutes >= lunchStartMinutes && slotStartMinutes < lunchEndMinutes) {
                    // This is a lunch slot
                    timeSlots.push({
                        time: `${slotStart}-${slotEnd}`,
                        type: 'lunch',
                        display: 'LUNCH BREAK'
                    });
                } else if (slotEndMinutes > lunchStartMinutes && slotEndMinutes <= lunchEndMinutes) {
                    // This slot ends during lunch, skip it
                    continue;
                } else if (slotStartMinutes < lunchStartMinutes && slotEndMinutes > lunchEndMinutes) {
                    // This slot spans across lunch, split it
                    // Add slot before lunch
                    const preLunchEnd = minutesToTime(lunchStartMinutes);
                    timeSlots.push({
                        time: `${slotStart}-${preLunchEnd}`,
                        type: 'class',
                        display: `${slotStart}-${preLunchEnd}`
                    });
                    
                    // Add lunch slot
                    timeSlots.push({
                        time: `${collegeWorkingHours.lunchStart}-${collegeWorkingHours.lunchEnd}`,
                        type: 'lunch',
                        display: 'LUNCH BREAK'
                    });
                    
                    // Add slot after lunch
                    const postLunchStart = minutesToTime(lunchEndMinutes);
                    timeSlots.push({
                        time: `${postLunchStart}-${slotEnd}`,
                        type: 'class',
                        display: `${postLunchStart}-${slotEnd}`
                    });
                } else {
                    // Regular class slot
                    timeSlots.push({
                        time: `${slotStart}-${slotEnd}`,
                        type: 'class',
                        display: `${slotStart}-${slotEnd}`
                    });
                }
            }
        }

        function updateTimeSlotsPreview() {
            const previewContainer = document.getElementById('timeSlotsPreview');
            previewContainer.innerHTML = '';

            timeSlots.forEach(slot => {
                const slotElement = document.createElement('div');
                slotElement.className = `time-slot-item ${slot.type}`;
                slotElement.textContent = slot.display;
                previewContainer.appendChild(slotElement);
            });
        }

        function updateWorkingHoursSummary() {
            const summaryContainer = document.getElementById('workingHoursSummary');
            
            const totalSlots = timeSlots.length;
            const classSlots = timeSlots.filter(slot => slot.type === 'class').length;
            const lunchSlots = timeSlots.filter(slot => slot.type === 'lunch').length;
            
            const startTime = formatTime(collegeWorkingHours.startTime);
            const endTime = formatTime(collegeWorkingHours.endTime);
            const totalHours = (timeToMinutes(collegeWorkingHours.endTime) - timeToMinutes(collegeWorkingHours.startTime)) / 60;
            
            summaryContainer.innerHTML = `
                <h5><i class="fas fa-chart-bar"></i> Working Hours Summary</h5>
                <div class="summary-stats">
                    <div class="summary-stat">
                        <span class="stat-number">${startTime} - ${endTime}</span>
                        <span class="stat-label">Working Hours</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-number">${totalHours}h</span>
                        <span class="stat-label">Total Duration</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-number">${classSlots}</span>
                        <span class="stat-label">Class Slots</span>
                    </div>
                    <div class="summary-stat">
                        <span class="stat-number">${lunchSlots}</span>
                        <span class="stat-label">Lunch Breaks</span>
                    </div>
                </div>
            `;
        }

        function setPreset(presetType) {
            switch (presetType) {
                case 'standard':
                    document.getElementById('startTime').value = '09:00';
                    document.getElementById('endTime').value = '17:00';
                    document.getElementById('lunchStart').value = '12:00';
                    document.getElementById('lunchEnd').value = '13:00';
                    break;
                case 'morning':
                    document.getElementById('startTime').value = '08:00';
                    document.getElementById('endTime').value = '16:00';
                    document.getElementById('lunchStart').value = '12:00';
                    document.getElementById('lunchEnd').value = '13:00';
                    break;
                case 'extended':
                    document.getElementById('startTime').value = '08:00';
                    document.getElementById('endTime').value = '18:00';
                    document.getElementById('lunchStart').value = '12:00';
                    document.getElementById('lunchEnd').value = '13:00';
                    break;
                case 'custom':
                    // Allow user to set custom times
                    showStatus('workingHoursStatus', 'Set your custom working hours using the time inputs above.', 'info');
                    return;
            }
            
            updateWorkingHours();
            showStatus('workingHoursStatus', `${presetType.charAt(0).toUpperCase() + presetType.slice(1)} preset applied successfully!`, 'success');
        }

        function proceedToSemesterSelection() {
            if (timeSlots.length === 0) {
                showStatus('workingHoursStatus', 'Please configure working hours first.', 'error');
                return;
            }

            updateWorkflowStep(1);
            showStep(1);
            initializeSemesterSelection();
        }

        // Utility functions for time handling
        function timeToMinutes(timeString) {
            const [hours, minutes] = timeString.split(':').map(Number);
            return hours * 60 + minutes;
        }

        function minutesToTime(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            return `${hours.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}`;
        }

        function formatTime(timeString) {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const displayHour = hour % 12 || 12;
            return `${displayHour}:${minutes} ${ampm}`;
        }

        // Available semesters grouped by course
        const availableSemesters = {
            'B.Tech': {
                'Computer Science': [
                    { id: 'btech_cse_1', semester: 1, name: 'B.Tech CSE - 1st Semester', students: 60, sections: ['A', 'B'] },
                    { id: 'btech_cse_2', semester: 2, name: 'B.Tech CSE - 2nd Semester', students: 58, sections: ['A', 'B'] },
                    { id: 'btech_cse_3', semester: 3, name: 'B.Tech CSE - 3rd Semester', students: 55, sections: ['A', 'B'] },
                    { id: 'btech_cse_4', semester: 4, name: 'B.Tech CSE - 4th Semester', students: 52, sections: ['A', 'B'] },
                    { id: 'btech_cse_5', semester: 5, name: 'B.Tech CSE - 5th Semester', students: 50, sections: ['A', 'B'] },
                    { id: 'btech_cse_6', semester: 6, name: 'B.Tech CSE - 6th Semester', students: 48, sections: ['A', 'B'] },
                    { id: 'btech_cse_7', semester: 7, name: 'B.Tech CSE - 7th Semester', students: 45, sections: ['A', 'B'] },
                    { id: 'btech_cse_8', semester: 8, name: 'B.Tech CSE - 8th Semester', students: 42, sections: ['A', 'B'] }
                ],
                'Electronics & Communication': [
                    { id: 'btech_ece_1', semester: 1, name: 'B.Tech ECE - 1st Semester', students: 55, sections: ['A', 'B'] },
                    { id: 'btech_ece_2', semester: 2, name: 'B.Tech ECE - 2nd Semester', students: 53, sections: ['A', 'B'] },
                    { id: 'btech_ece_3', semester: 3, name: 'B.Tech ECE - 3rd Semester', students: 50, sections: ['A', 'B'] },
                    { id: 'btech_ece_4', semester: 4, name: 'B.Tech ECE - 4th Semester', students: 48, sections: ['A', 'B'] }
                ],
                'Mechanical Engineering': [
                    { id: 'btech_mech_1', semester: 1, name: 'B.Tech MECH - 1st Semester', students: 50, sections: ['A'] },
                    { id: 'btech_mech_2', semester: 2, name: 'B.Tech MECH - 2nd Semester', students: 48, sections: ['A'] }
                ]
            },
            'M.Tech': {
                'Computer Science': [
                    { id: 'mtech_cse_1', semester: 1, name: 'M.Tech CSE - 1st Semester', students: 30, sections: ['A'] },
                    { id: 'mtech_cse_2', semester: 2, name: 'M.Tech CSE - 2nd Semester', students: 28, sections: ['A'] },
                    { id: 'mtech_cse_3', semester: 3, name: 'M.Tech CSE - 3rd Semester', students: 25, sections: ['A'] },
                    { id: 'mtech_cse_4', semester: 4, name: 'M.Tech CSE - 4th Semester', students: 22, sections: ['A'] }
                ]
            },
            'MBA': {
                'Management': [
                    { id: 'mba_1', semester: 1, name: 'MBA - 1st Semester', students: 40, sections: ['A', 'B'] },
                    { id: 'mba_2', semester: 2, name: 'MBA - 2nd Semester', students: 38, sections: ['A', 'B'] },
                    { id: 'mba_3', semester: 3, name: 'MBA - 3rd Semester', students: 35, sections: ['A', 'B'] },
                    { id: 'mba_4', semester: 4, name: 'MBA - 4th Semester', students: 32, sections: ['A', 'B'] }
                ]
            },
            'BCA': {
                'Computer Applications': [
                    { id: 'bca_1', semester: 1, name: 'BCA - 1st Semester', students: 45, sections: ['A'] },
                    { id: 'bca_2', semester: 2, name: 'BCA - 2nd Semester', students: 43, sections: ['A'] },
                    { id: 'bca_3', semester: 3, name: 'BCA - 3rd Semester', students: 40, sections: ['A'] },
                    { id: 'bca_4', semester: 4, name: 'BCA - 4th Semester', students: 38, sections: ['A'] },
                    { id: 'bca_5', semester: 5, name: 'BCA - 5th Semester', students: 35, sections: ['A'] },
                    { id: 'bca_6', semester: 6, name: 'BCA - 6th Semester', students: 32, sections: ['A'] }
                ]
            }
        };

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeSemesterSelection();
        });

        // Step 1: Initialize Multi-Semester Selection
        function initializeSemesterSelection() {
            const courseGroupsContainer = document.getElementById('courseGroups');
            courseGroupsContainer.innerHTML = '';

            Object.keys(availableSemesters).forEach(course => {
                const courseGroup = document.createElement('div');
                courseGroup.className = 'course-group';
                
                const courseHeader = document.createElement('div');
                courseHeader.className = 'course-group-header';
                courseHeader.onclick = () => toggleCourseGroup(course);
                courseHeader.innerHTML = `
                    <span><i class="fas fa-graduation-cap"></i> ${course}</span>
                    <i class="fas fa-chevron-down" id="chevron-${course}"></i>
                `;
                
                const courseContent = document.createElement('div');
                courseContent.className = 'course-group-content';
                courseContent.id = `content-${course}`;
                
                // Add branches for this course
                Object.keys(availableSemesters[course]).forEach(branch => {
                    const branchDiv = document.createElement('div');
                    branchDiv.innerHTML = `<h4 style="margin-bottom: 15px; color: #4a5568;"><i class="fas fa-code-branch"></i> ${branch}</h4>`;
                    
                    const semesterGrid = document.createElement('div');
                    semesterGrid.className = 'semester-grid';
                    
                    availableSemesters[course][branch].forEach(semester => {
                        const semesterCard = document.createElement('div');
                        semesterCard.className = 'semester-checkbox-card';
                        semesterCard.id = `card-${semester.id}`;
                        
                        semesterCard.innerHTML = `
                            <div class="semester-checkbox">
                                <input type="checkbox" id="${semester.id}" value="${semester.id}" 
                                       onchange="toggleSemesterSelection('${semester.id}')">
                                <div class="semester-info">
                                    <div class="semester-name">${semester.name}</div>
                                    <div class="semester-details">${course}  ${branch}</div>
                                    <div class="semester-meta">
                                        <span><i class="fas fa-users"></i> ${semester.students} students</span>
                                        <span><i class="fas fa-layer-group"></i> ${semester.sections.length} sections</span>
                                        <span><i class="fas fa-calendar"></i> Semester ${semester.semester}</span>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        semesterGrid.appendChild(semesterCard);
                    });
                    
                    branchDiv.appendChild(semesterGrid);
                    courseContent.appendChild(branchDiv);
                });
                
                courseGroup.appendChild(courseHeader);
                courseGroup.appendChild(courseContent);
                courseGroupsContainer.appendChild(courseGroup);
            });
        }

        function toggleCourseGroup(course) {
            const content = document.getElementById(`content-${course}`);
            const chevron = document.getElementById(`chevron-${course}`);
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                chevron.classList.remove('fa-chevron-right');
                chevron.classList.add('fa-chevron-down');
            } else {
                content.classList.add('collapsed');
                chevron.classList.remove('fa-chevron-down');
                chevron.classList.add('fa-chevron-right');
            }
        }

        function toggleSemesterSelection(semesterId) {
            const checkbox = document.getElementById(semesterId);
            const card = document.getElementById(`card-${semesterId}`);
            
            if (checkbox.checked) {
                // Add to selected semesters
                const semester = findSemesterById(semesterId);
                if (semester && !selectedSemesters.find(s => s.id === semesterId)) {
                    selectedSemesters.push(semester);
                    card.classList.add('selected');
                }
            } else {
                // Remove from selected semesters
                selectedSemesters = selectedSemesters.filter(s => s.id !== semesterId);
                card.classList.remove('selected');
            }
            
            updateSelectionSummary();
            updateProceedButton();
        }

        function findSemesterById(semesterId) {
            for (const course of Object.keys(availableSemesters)) {
                for (const branch of Object.keys(availableSemesters[course])) {
                    const semester = availableSemesters[course][branch].find(s => s.id === semesterId);
                    if (semester) {
                        return { ...semester, course, branch };
                    }
                }
            }
            return null;
        }

        function updateSelectionSummary() {
            const summaryContainer = document.getElementById('selectionSummary');
            const countSpan = document.getElementById('selectedCount');
            const listContainer = document.getElementById('selectedSemestersList');
            
            if (selectedSemesters.length === 0) {
                summaryContainer.classList.add('hidden');
                return;
            }
            
            summaryContainer.classList.remove('hidden');
            countSpan.textContent = selectedSemesters.length;
            
            listContainer.innerHTML = '';
            selectedSemesters.forEach(semester => {
                const item = document.createElement('div');
                item.className = 'selected-semester-item';
                item.innerHTML = `
                    <div class="selected-semester-name">${semester.name}</div>
                    <div class="selected-semester-details">${semester.course}  ${semester.branch}  ${semester.sections.length} sections</div>
                `;
                listContainer.appendChild(item);
            });
        }

        function updateProceedButton() {
            const proceedBtn = document.getElementById('proceedToSectionBtn');
            const statusDiv = document.getElementById('semesterStatus');
            
            if (selectedSemesters.length === 0) {
                proceedBtn.disabled = true;
                statusDiv.className = 'status-message warning';
                statusDiv.textContent = 'Please select at least one semester to continue.';
            } else {
                proceedBtn.disabled = false;
                statusDiv.className = 'status-message success';
                statusDiv.textContent = `${selectedSemesters.length} semester(s) selected. Ready to proceed to section configuration.`;
            }
        }

        // Selection Control Functions
        function selectAllSemesters() {
            Object.keys(availableSemesters).forEach(course => {
                Object.keys(availableSemesters[course]).forEach(branch => {
                    availableSemesters[course][branch].forEach(semester => {
                        const checkbox = document.getElementById(semester.id);
                        if (!checkbox.checked) {
                            checkbox.checked = true;
                            toggleSemesterSelection(semester.id);
                        }
                    });
                });
            });
        }

        function clearAllSemesters() {
            selectedSemesters.forEach(semester => {
                const checkbox = document.getElementById(semester.id);
                const card = document.getElementById(`card-${semester.id}`);
                checkbox.checked = false;
                card.classList.remove('selected');
            });
            
            selectedSemesters = [];
            updateSelectionSummary();
            updateProceedButton();
        }

        function selectByCourse(targetCourse) {
            if (availableSemesters[targetCourse]) {
                Object.keys(availableSemesters[targetCourse]).forEach(branch => {
                    availableSemesters[targetCourse][branch].forEach(semester => {
                        const checkbox = document.getElementById(semester.id);
                        if (!checkbox.checked) {
                            checkbox.checked = true;
                            toggleSemesterSelection(semester.id);
                        }
                    });
                });
            }
        }

        function proceedToSectionConfiguration() {
            if (selectedSemesters.length === 0) {
                showStatus('semesterStatus', 'Please select at least one semester.', 'error');
                return;
            }

            updateWorkflowStep(2);
            showStep(2);
            initializeSectionConfiguration();
        }

        // Step 2: Section Configuration
        function initializeSectionConfiguration() {
            const configContainer = document.getElementById('sectionConfiguration');
            configContainer.innerHTML = '';
            
            selectedSemesters.forEach(semester => {
                const semesterDiv = document.createElement('div');
                semesterDiv.className = 'course-group';
                semesterDiv.innerHTML = `
                    <div class="course-group-header">
                        <span><i class="fas fa-graduation-cap"></i> ${semester.name}</span>
                        <span>${semester.course}  ${semester.branch}</span>
                    </div>
                    <div class="course-group-content">
                        <h4 style="margin-bottom: 15px; color: #4a5568;">Select Sections for ${semester.name}:</h4>
                        <div class="semester-grid" id="sections-${semester.id}">
                            ${semester.sections.map(section => `
                                <div class="semester-checkbox-card" id="section-card-${semester.id}-${section}">
                                    <div class="semester-checkbox">
                                        <input type="checkbox" id="section-${semester.id}-${section}" 
                                               value="${section}" onchange="toggleSectionSelection('${semester.id}', '${section}')">
                                        <div class="semester-info">
                                            <div class="semester-name">Section ${section}</div>
                                            <div class="semester-details">Capacity: ${semester.students} students</div>
                                            <div class="semester-meta">
                                                <span><i class="fas fa-users"></i> Active section</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                configContainer.appendChild(semesterDiv);
            });
            
            // Initialize section configurations
            selectedSemesters.forEach(semester => {
                if (!sectionConfigurations[semester.id]) {
                    sectionConfigurations[semester.id] = [];
                }
            });
        }

        function toggleSectionSelection(semesterId, section) {
            const checkbox = document.getElementById(`section-${semesterId}-${section}`);
            const card = document.getElementById(`section-card-${semesterId}-${section}`);
            
            if (!sectionConfigurations[semesterId]) {
                sectionConfigurations[semesterId] = [];
            }
            
            if (checkbox.checked) {
                if (!sectionConfigurations[semesterId].includes(section)) {
                    sectionConfigurations[semesterId].push(section);
                    card.classList.add('selected');
                }
            } else {
                sectionConfigurations[semesterId] = sectionConfigurations[semesterId].filter(s => s !== section);
                card.classList.remove('selected');
            }
            
            updateSectionProceedButton();
        }

        function updateSectionProceedButton() {
            const proceedBtn = document.getElementById('proceedToLectureBtn');
            const statusDiv = document.getElementById('sectionStatus');
            
            const totalSections = Object.values(sectionConfigurations).reduce((sum, sections) => sum + sections.length, 0);
            
            if (totalSections === 0) {
                proceedBtn.disabled = true;
                statusDiv.className = 'status-message warning';
                statusDiv.textContent = 'Please select at least one section for each semester.';
            } else {
                proceedBtn.disabled = false;
                statusDiv.className = 'status-message success';
                statusDiv.textContent = `${totalSections} section(s) configured across ${selectedSemesters.length} semester(s). Ready to proceed.`;
            }
        }

        function proceedToLectureDetails() {
            const hasValidSections = Object.keys(sectionConfigurations).every(semesterId => 
                sectionConfigurations[semesterId].length > 0
            );
            
            if (!hasValidSections) {
                showStatus('sectionStatus', 'Please select at least one section for each semester.', 'error');
                return;
            }

            updateWorkflowStep(3);
            showStep(3);
            initializeLectureConfiguration();
        }

        // Continue with more functions in the next part...

        // Step 3: Lecture Configuration
        function initializeLectureConfiguration() {
            const configContainer = document.getElementById('lectureConfiguration');
            configContainer.innerHTML = '';
            
            selectedSemesters.forEach(semester => {
                const sections = sectionConfigurations[semester.id] || [];
                
                sections.forEach(section => {
                    const lectureDiv = document.createElement('div');
                    lectureDiv.className = 'course-group';
                    lectureDiv.innerHTML = `
                        <div class="course-group-header">
                            <span><i class="fas fa-chalkboard-teacher"></i> ${semester.name} - Section ${section}</span>
                            <button class="control-btn" onclick="addLectureForSemesterSection('${semester.id}', '${section}')">
                                <i class="fas fa-plus"></i> Add Lecture
                            </button>
                        </div>
                        <div class="course-group-content" id="lectures-${semester.id}-${section}">
                            <p style="color: #718096; font-style: italic;">Click "Add Lecture" to add subjects for this semester and section.</p>
                        </div>
                    `;
                    configContainer.appendChild(lectureDiv);
                    
                    // Initialize lecture configurations
                    const key = `${semester.id}-${section}`;
                    if (!lectureConfigurations[key]) {
                        lectureConfigurations[key] = [];
                    }
                });
            });
        }

        function addLectureForSemesterSection(semesterId, section) {
            const container = document.getElementById(`lectures-${semesterId}-${section}`);
            const key = `${semesterId}-${section}`;
            const lectureId = `lecture-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            
            // Remove empty message if it exists
            if (container.querySelector('p')) {
                container.innerHTML = '';
            }
            
            const lectureDiv = document.createElement('div');
            lectureDiv.className = 'lecture-container';
            lectureDiv.id = lectureId;
            lectureDiv.style.cssText = `
                border: 2px solid #e2e8f0;
                border-radius: 10px;
                padding: 20px;
                margin-bottom: 15px;
                background: white;
            `;
            
            lectureDiv.innerHTML = `
                <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 15px;">
                    <h4 style="color: #4a5568;">Lecture ${lectureConfigurations[key].length + 1}</h4>
                    <button class="control-btn secondary" onclick="removeLecture('${lectureId}', '${key}')">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                    <div class="form-group">
                        <label>Lecture Type:</label>
                        <select class="lecture-type" required>
                            <option value="">Select Type</option>
                            <option value="theory">Theory</option>
                            <option value="lab">LAB</option>
                            <option value="practical">Practical</option>
                            <option value="tutorial">Tutorial</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Subject Code:</label>
                        <input type="text" class="subject-code" placeholder="e.g., CS701, MATH101" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Subject Name:</label>
                        <input type="text" class="subject-name" placeholder="e.g., Machine Learning" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Faculty Code:</label>
                        <input type="text" class="faculty-code" placeholder="e.g., DR.SM, PROF.JD" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Faculty Name:</label>
                        <input type="text" class="faculty-name" placeholder="e.g., Dr. Smith" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Total Weekly Hours:</label>
                        <input type="number" class="hours-per-week" min="1" max="10" placeholder="e.g., 4" required>
                        <small style="color: #718096; display: block; margin-top: 5px;">
                            System will automatically distribute these hours across the week
                        </small>
                    </div>
                </div>
            `;
            
            container.appendChild(lectureDiv);
        }

        function removeLecture(lectureId, key) {
            const lectureDiv = document.getElementById(lectureId);
            if (lectureDiv) {
                lectureDiv.remove();
                
                // Check if container is empty
                const container = lectureDiv.parentElement;
                if (container && container.children.length === 0) {
                    container.innerHTML = '<p style="color: #718096; font-style: italic;">Click "Add Lecture" to add subjects for this semester and section.</p>';
                }
            }
        }

        function proceedToGeneration() {
            // Collect all lecture details
            lectureConfigurations = {};
            let totalLectures = 0;
            
            selectedSemesters.forEach(semester => {
                const sections = sectionConfigurations[semester.id] || [];
                
                sections.forEach(section => {
                    const key = `${semester.id}-${section}`;
                    const container = document.getElementById(`lectures-${semester.id}-${section}`);
                    const lectureContainers = container.querySelectorAll('.lecture-container');
                    
                    lectureConfigurations[key] = [];
                    
                    lectureContainers.forEach(lectureDiv => {
                        const lectureType = lectureDiv.querySelector('.lecture-type').value;
                        const subjectCode = lectureDiv.querySelector('.subject-code').value.trim();
                        const subjectName = lectureDiv.querySelector('.subject-name').value.trim();
                        const facultyCode = lectureDiv.querySelector('.faculty-code').value.trim();
                        const facultyName = lectureDiv.querySelector('.faculty-name').value.trim();
                        const hoursPerWeek = lectureDiv.querySelector('.hours-per-week').value;
                        
                        if (lectureType && subjectCode && subjectName && facultyCode && facultyName && hoursPerWeek) {
                            lectureConfigurations[key].push({
                                subjectType: lectureType, // Renamed for consistency
                                subjectCode,
                                subjectName,
                                facultyCode,
                                facultyName,
                                hoursPerWeek: parseInt(hoursPerWeek)
                            });
                            totalLectures++;
                        }
                    });
                });
            });
            
            if (totalLectures === 0) {
                showStatus('lectureStatus', 'Please add at least one lecture for the selected semesters and sections.', 'error');
                return;
            }

            updateWorkflowStep(4);
            showStep(4);
            generateAllTimetables();
        }

        // Step 4: Generate All Timetables
        function generateAllTimetables() {
            console.log('generateAllTimetables called');
            document.getElementById('loading').classList.add('show');
            
            setTimeout(() => {
                console.log('Starting performMultiSemesterGeneration...');
                try {
                    const results = performMultiSemesterGeneration();
                    console.log('Generation results:', results);
                    
                    document.getElementById('loading').classList.remove('show');
                    
                    if (results.success) {
                        console.log('Generation successful, updating UI...');
                        generatedTimetables = results.timetables;
                        
                        // Generate success message with faculty workload summary
                        let successMessage = `
                            <div class="status-message success">
                                <i class="fas fa-check-circle"></i>
                                Successfully generated timetables for all selected semesters!
                                <br><small>Generated ${Object.keys(generatedTimetables).length} timetable(s) with no faculty conflicts detected.</small>
                            </div>
                        `;
                        
                        // Add faculty workload summary if available
                        if (results.facultyWorkloadSummary) {
                            successMessage += generateFacultyWorkloadDisplay(results.facultyWorkloadSummary);
                        }
                        
                        document.getElementById('generationResults').innerHTML = successMessage;
                        document.getElementById('generationButtons').style.display = 'flex';
                        
                        // Show the preview section
                        showTimetablePreview();
                        
                    } else {
                    // Enhanced error display for daily hour limit violations
                    let errorMessage = `
                        <div class="status-message error">
                            <i class="fas fa-exclamation-triangle"></i>
                            ${results.error}
                    `;
                    
                    // Add debugging information
                    if (results.details) {
                        errorMessage += `
                            <br><br><strong>Error Details:</strong>
                            <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 12px;">
                                ${results.details}
                            </div>
                        `;
                    }
                    
                    if (results.stack) {
                        errorMessage += `
                            <br><strong>Stack Trace:</strong>
                            <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto;">
                                ${results.stack.replace(/\n/g, '<br>')}
                            </div>
                        `;
                    }
                    
                    if (results.errorType === 'DAILY_HOUR_LIMIT_EXCEEDED' && results.errorDetails) {
                        errorMessage += `
                            <br><br><strong>Faculty Daily Hour Limit Violation Details:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li><strong>Faculty:</strong> ${results.errorDetails.facultyName} (${results.errorDetails.facultyCode})</li>
                                <li><strong>Violation Day:</strong> ${results.errorDetails.violationDay}</li>
                                <li><strong>Assigned Hours:</strong> ${results.errorDetails.currentHours} hours</li>
                                <li><strong>Daily Limit:</strong> ${results.errorDetails.limit} hours</li>
                                <li><strong>Semester/Section:</strong> ${results.errorDetails.semester} - Section ${results.errorDetails.section}</li>
                            </ul>
                            <br><strong>Suggestions:</strong>
                            <ul style="margin: 10px 0; padding-left: 20px;">
                                <li>Reduce the hours per week for some subjects taught by this faculty</li>
                                <li>Assign some subjects to different faculty members</li>
                                <li>Distribute the faculty's load across different days</li>
                            </ul>
                        `;
                    }
                    
                    errorMessage += `
                            <br><small>Please adjust lecture details and try again.</small>
                        </div>
                    `;
                    
                    document.getElementById('generationResults').innerHTML = errorMessage;
                    document.getElementById('generationButtons').style.display = 'flex';
                    document.getElementById('proceedToPreviewBtn').disabled = true;
                }
            } catch (error) {
                console.error('Error in generateAllTimetables:', error);
                document.getElementById('loading').classList.remove('show');
                
                const errorMessage = `
                    <div class="status-message error">
                        <i class="fas fa-exclamation-triangle"></i>
                        An error occurred during timetable generation.
                        <br><br><strong>Error Details:</strong>
                        <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 12px;">
                            ${error.message}
                        </div>
                        <br><strong>Stack Trace:</strong>
                        <div style="background: #f8f8f8; padding: 10px; border-radius: 5px; margin: 10px 0; font-family: monospace; font-size: 11px; max-height: 200px; overflow-y: auto;">
                            ${error.stack ? error.stack.replace(/\n/g, '<br>') : 'No stack trace available'}
                        </div>
                    </div>
                `;
                
                document.getElementById('generationResults').innerHTML = errorMessage;
                document.getElementById('generationButtons').style.display = 'none';
            }
            }, 3000);
        }

        // Function to show timetable preview
        function showTimetablePreview() {
            console.log('showTimetablePreview called');
            console.log('generatedTimetables:', generatedTimetables);
            
            if (!generatedTimetables || Object.keys(generatedTimetables).length === 0) {
                console.log('No timetables to preview');
                return;
            }
            
            // Use the existing comprehensive preview function
            displayAllTimetablePreviews();
        }

        // Function to render timetable HTML
        function renderTimetableHTML(timetable, key) {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const currentTimeSlots = timeSlots.map(slot => slot.display);
            
            let html = `
                <div class="timetable-container">
                    <table class="timetable-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                ${days.map(day => `<th>${day}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            currentTimeSlots.forEach((timeSlot, timeIndex) => {
                html += `<tr><td class="time-slot">${timeSlot}</td>`;
                
                days.forEach(day => {
                    const classInfo = timetable[day][timeIndex];
                    
                    if (classInfo) {
                        if (classInfo.type === 'lunch') {
                            html += `<td class="lunch-cell">${classInfo.content}</td>`;
                        } else {
                            html += `
                                <td class="class-cell ${classInfo.lectureType}">
                                    <div class="subject-code">${classInfo.subjectCode}</div>
                                    <div class="subject-name">${classInfo.subjectName}</div>
                                    <div class="faculty-info">${classInfo.facultyCode}</div>
                                    <div class="room-info">${classInfo.room}</div>
                                    <div class="lecture-type">${classInfo.lectureType.toUpperCase()}</div>
                                </td>
                            `;
                        }
                    } else {
                        html += `<td class="empty-cell"></td>`;
                    }
                });
                
                html += `</tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }

        // Function to edit timetable
        function editTimetable(key) {
            console.log('Edit timetable:', key);
            // TODO: Implement edit functionality
            alert('Edit functionality will be implemented in the next version.');
        }

        // Function to download timetable as PDF
        function downloadTimetablePDF(key) {
            console.log('Download PDF for:', key);
            const timetableData = generatedTimetables[key];
            if (!timetableData) {
                alert('Timetable data not found.');
                return;
            }
            
            // TODO: Implement PDF download
            alert('PDF download functionality will be implemented in the next version.');
        }

        // Generate faculty workload display
        function generateFacultyWorkloadDisplay(facultyWorkloadSummary) {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const DAILY_HOUR_LIMIT = 6;
            
            let workloadHTML = `
                <div class="faculty-workload-summary" style="background: #f0f8ff; border: 2px solid #4299e1; border-radius: 10px; padding: 20px; margin-top: 15px;">
                    <h4 style="color: #2d3748; margin-bottom: 15px;">
                        <i class="fas fa-user-clock"></i> Faculty Workload Summary
                    </h4>
                    <div style="overflow-x: auto;">
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
                            <thead>
                                <tr style="background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%); color: white;">
                                    <th style="padding: 12px 8px; border: 1px solid #e2e8f0;">Faculty</th>
                                    <th style="padding: 12px 8px; border: 1px solid #e2e8f0;">Monday</th>
                                    <th style="padding: 12px 8px; border: 1px solid #e2e8f0;">Tuesday</th>
                                    <th style="padding: 12px 8px; border: 1px solid #e2e8f0;">Wednesday</th>
                                    <th style="padding: 12px 8px; border: 1px solid #e2e8f0;">Thursday</th>
                                    <th style="padding: 12px 8px; border: 1px solid #e2e8f0;">Friday</th>
                                    <th style="padding: 10px 8px; border: 1px solid #e2e8f0;">Saturday</th>
                                    <th style="padding: 12px 8px; border: 1px solid #e2e8f0;">Total</th>
                                    <th style="padding: 12px 8px; border: 1px solid #e2e8f0;">Status</th>
                                </tr>
                            </thead>
                            <tbody>
            `;
            
            Object.keys(facultyWorkloadSummary).forEach(facultyCode => {
                const faculty = facultyWorkloadSummary[facultyCode];
                const hasViolations = faculty.violations.length > 0;
                const rowStyle = hasViolations ? 'background: #fed7d7;' : 'background: #f7fafc;';
                
                workloadHTML += `
                    <tr style="${rowStyle}">
                        <td style="padding: 10px 8px; border: 1px solid #e2e8f0; font-weight: 600;">
                            ${faculty.name}<br>
                            <small style="color: #718096;">${facultyCode}</small>
                        </td>
                `;
                
                days.forEach(day => {
                    const hours = faculty.dailyHours[day];
                    const isOverLimit = hours > DAILY_HOUR_LIMIT;
                    const cellStyle = isOverLimit ? 
                        'background: #fc8181; color: white; font-weight: bold;' : 
                        hours > 4 ? 'background: #fbb6ce; color: #742a2a;' : '';
                    
                    workloadHTML += `
                        <td style="padding: 10px 8px; border: 1px solid #e2e8f0; text-align: center; ${cellStyle}">
                            ${hours}h
                            ${isOverLimit ? '<br><small> OVER</small>' : ''}
                        </td>
                    `;
                });
                
                workloadHTML += `
                        <td style="padding: 10px 8px; border: 1px solid #e2e8f0; text-align: center; font-weight: 600;">
                            ${faculty.totalWeeklyHours}h
                        </td>
                        <td style="padding: 10px 8px; border: 1px solid #e2e8f0; text-align: center;">
                            ${hasViolations ? 
                                '<span style="color: #e53e3e; font-weight: bold;"><i class="fas fa-exclamation-triangle"></i> VIOLATION</span>' : 
                                '<span style="color: #38a169; font-weight: bold;"><i class="fas fa-check-circle"></i> OK</span>'
                            }
                        </td>
                    </tr>
                `;
            });
            
            workloadHTML += `
                            </tbody>
                        </table>
                    </div>
                    <div style="margin-top: 15px; font-size: 0.9rem; color: #4a5568;">
                        <strong>Legend:</strong>
                        <span style="background: #fc8181; color: white; padding: 2px 6px; border-radius: 3px; margin: 0 5px;">Over ${DAILY_HOUR_LIMIT}h</span>
                        <span style="background: #fbb6ce; color: #742a2a; padding: 2px 6px; border-radius: 3px; margin: 0 5px;">4-${DAILY_HOUR_LIMIT}h</span>
                        <span style="background: #f7fafc; padding: 2px 6px; border-radius: 3px; margin: 0 5px;">Under 4h</span>
                    </div>
                </div>
            `;
            
            return workloadHTML;
        }

        function performMultiSemesterGeneration() {
            try {
                console.log('Starting multi-semester generation...');
                const timetables = {};
                const globalFacultySchedule = {}; // Track faculty across all semesters
                const globalFacultyDailyHours = {}; // Track daily hours across all semesters
                const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']; // Define days in main scope
                
                // Initialize global faculty daily hours tracking
                const initializeGlobalFacultyHours = () => {
                    console.log('Initializing global faculty hours...');
                    console.log('lectureConfigurations keys:', Object.keys(lectureConfigurations));
                    
                    Object.keys(lectureConfigurations).forEach(key => {
                        const subjects = lectureConfigurations[key]; // Changed from lectures to subjects
                        console.log(`Processing key: ${key}, subjects:`, subjects);
                        
                        subjects.forEach(subject => { // Changed from lecture to subject
                            if (!globalFacultyDailyHours[subject.facultyCode]) {
                                globalFacultyDailyHours[subject.facultyCode] = {};
                                days.forEach(day => {
                                    globalFacultyDailyHours[subject.facultyCode][day] = 0;
                                });
                            }
                        });
                    });
                    console.log('Global faculty hours initialized:', globalFacultyDailyHours);
                };
                
                initializeGlobalFacultyHours();
                
                // Generate timetable for each semester-section combination
                console.log('Starting timetable generation for each semester-section...');
                Object.keys(lectureConfigurations).forEach(key => {
                    console.log(`Processing key: ${key}`);
                    const [semesterId, section] = key.split('-');
                    const semester = selectedSemesters.find(s => s.id === semesterId);
                    const subjects = lectureConfigurations[key]; // Renamed from lectures to subjects
                    
                    console.log(`Semester:`, semester);
                    console.log(`Section: ${section}`);
                    console.log(`Subjects:`, subjects);
                    
                    if (subjects.length > 0) {
                        console.log(`Calling generateSingleTimetable for ${key}...`);
                        const result = generateSingleTimetable(
                            semester, 
                            section, 
                            subjects, // Pass subjects instead of lectures
                            globalFacultySchedule, 
                            globalFacultyDailyHours
                        );
                        
                        console.log(`Result for ${key}:`, result);
                        
                        // The new generateSingleTimetableNew always returns a result object
                        timetables[key] = {
                            semester,
                            section,
                            subjects, // Store subjects for new functionality
                            lectures: subjects, // Also store as lectures for backward compatibility
                            timetable: result.timetable,
                            placedLectures: result.placedLectures,
                            totalLectures: result.totalLectures,
                            failedPlacements: result.failedPlacements
                        };
                        
                        // Update global faculty daily hours
                        Object.keys(result.localFacultyDailyHours).forEach(facultyCode => {
                            if (!globalFacultyDailyHours[facultyCode]) {
                                globalFacultyDailyHours[facultyCode] = {};
                                days.forEach(day => {
                                    globalFacultyDailyHours[facultyCode][day] = 0;
                                });
                            }
                            
                            days.forEach(day => {
                                globalFacultyDailyHours[facultyCode][day] += 
                                    result.localFacultyDailyHours[facultyCode][day] || 0;
                            });
                        });
                    }
                });
                
                // Final validation: Generate faculty workload summary
                const facultyWorkloadSummary = generateFacultyWorkloadSummary(globalFacultyDailyHours);
                
                return { 
                    success: true, 
                    timetables,
                    facultyWorkloadSummary
                };
                
            } catch (error) {
                console.error('Multi-semester generation error:', error);
                console.error('Error stack:', error.stack);
                console.error('lectureConfigurations:', lectureConfigurations);
                console.error('selectedSemesters:', selectedSemesters);
                return { 
                    success: false, 
                    error: 'An error occurred during multi-semester timetable generation.',
                    details: error.message,
                    stack: error.stack
                };
            }
        }

        // Generate faculty workload summary
        function generateFacultyWorkloadSummary(globalFacultyDailyHours) {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            const summary = {};
            const DAILY_HOUR_LIMIT = 6;
            
            Object.keys(globalFacultyDailyHours).forEach(facultyCode => {
                // Find faculty name from lecture configurations
                let facultyName = facultyCode;
                Object.keys(lectureConfigurations).forEach(key => {
                    const lectures = lectureConfigurations[key];
                    const facultyInfo = lectures.find(l => l.facultyCode === facultyCode);
                    if (facultyInfo) {
                        facultyName = facultyInfo.facultyName;
                    }
                });
                
                summary[facultyCode] = {
                    name: facultyName,
                    dailyHours: { ...globalFacultyDailyHours[facultyCode] },
                    totalWeeklyHours: 0,
                    maxDailyHours: 0,
                    violations: []
                };
                
                days.forEach(day => {
                    const hours = globalFacultyDailyHours[facultyCode][day];
                    summary[facultyCode].totalWeeklyHours += hours;
                    summary[facultyCode].maxDailyHours = Math.max(summary[facultyCode].maxDailyHours, hours);
                    
                    if (hours > DAILY_HOUR_LIMIT) {
                        summary[facultyCode].violations.push({
                            day: day,
                            hours: hours,
                            excess: hours - DAILY_HOUR_LIMIT
                        });
                    }
                });
            });
            
            return summary;
        }

        function generateSingleTimetable(semester, section, subjects, globalFacultySchedule, globalFacultyDailyHours = {}) {
            console.log('generateSingleTimetable called with:', { semester, section, subjects });
            
            // Use dynamic time slots based on working hours
            const currentTimeSlots = timeSlots.map(slot => slot.display);
            const DAILY_HOUR_LIMIT = 6; // Maximum hours per faculty per day
            
            try {
                // Convert subjects to distributed lectures
                console.log('Converting subjects to lectures...');
                const lectures = [];
                subjects.forEach(subject => {
                    console.log('Processing subject:', subject);
                    const distributedLectures = distributeWeeklyHours({
                        subjectCode: subject.subjectCode,
                        subjectName: subject.subjectName,
                        facultyCode: subject.facultyCode,
                        facultyName: subject.facultyName,
                        subjectType: subject.subjectType,
                        weeklyHours: subject.hoursPerWeek
                    });
                    console.log('Distributed lectures:', distributedLectures);
                    lectures.push(...distributedLectures);
                });
                
                console.log('Total lectures to place:', lectures.length);
                
                // Initialize empty timetable
                const timetable = {};
                days.forEach(day => {
                    timetable[day] = new Array(currentTimeSlots.length).fill(null);
                });
                
                // Add lunch breaks to timetable
                timeSlots.forEach((slot, index) => {
                    if (slot.type === 'lunch') {
                        days.forEach(day => {
                            timetable[day][index] = { type: 'lunch', content: 'LUNCH BREAK' };
                        });
                    }
                });
                
                const localFacultyDailyHours = {};
                
                // Initialize daily hour tracking for local faculty
                lectures.forEach(lecture => {
                    if (!localFacultyDailyHours[lecture.facultyCode]) {
                        localFacultyDailyHours[lecture.facultyCode] = {};
                        days.forEach(day => {
                            localFacultyDailyHours[lecture.facultyCode][day] = 0;
                        });
                    }
                });
                
                // Simple placement algorithm (for now, just place lectures sequentially)
                const rooms = ['T1', 'T2', 'T3', 'Lab1', 'Lab2', 'Lab3', 'LT01', 'LT02'];
                let lectureIndex = 0;
                let placedLectures = 0;
                
                for (const day of days) {
                    for (let timeIndex = 0; timeIndex < currentTimeSlots.length; timeIndex++) {
                        // Skip lunch slots and already occupied slots
                        if (timeSlots[timeIndex].type === 'lunch' || timetable[day][timeIndex] !== null) {
                            continue;
                        }
                        
                        if (lectureIndex < lectures.length) {
                            const lecture = lectures[lectureIndex];
                            
                            // Simple placement without complex constraints for now
                            const lectureInfo = {
                                subjectCode: lecture.subjectCode,
                                subjectName: lecture.subjectName,
                                facultyCode: lecture.facultyCode,
                                facultyName: lecture.facultyName,
                                lectureType: lecture.lectureType,
                                room: rooms[lectureIndex % rooms.length],
                                hours: lecture.hours
                            };
                            
                            timetable[day][timeIndex] = lectureInfo;
                            
                            // Update global faculty schedule
                            globalFacultySchedule[`${lecture.facultyCode}-${day}-${timeIndex}`] = 
                                `${semester.name} Section ${section}`;
                            
                            // Update local faculty daily hours
                            localFacultyDailyHours[lecture.facultyCode][day] += lecture.hours;
                            
                            lectureIndex++;
                            placedLectures++;
                        }
                    }
                }
                
                console.log(`Placed ${placedLectures}/${lectures.length} lectures`);
                
                return {
                    timetable,
                    localFacultyDailyHours,
                    failedPlacements: lectures.slice(placedLectures).map(l => ({
                        lecture: `${l.subjectCode} (${l.lectureType}, ${l.hours}h)`,
                        faculty: `${l.facultyName} (${l.facultyCode})`,
                        attempts: ['No available slots']
                    })),
                    totalLectures: lectures.length,
                    placedLectures: placedLectures
                };
                
            } catch (error) {
                console.error('Error in generateSingleTimetable:', error);
                throw error;
            }
        }

        function distributeWeeklyHours(subjectData) {
            const { 
                subjectCode, 
                subjectName, 
                facultyCode, 
                facultyName, 
                subjectType, 
                weeklyHours 
            } = subjectData;
            
            const lectures = [];
            let remainingHours = parseInt(weeklyHours);
            
            // Define session types and their typical durations
            const sessionTypes = {
                theory: { duration: 1, maxPerDay: 1 },
                lab: { duration: 2, maxPerDay: 1 },
                practical: { duration: 2, maxPerDay: 1 }
            };
            
            const currentType = sessionTypes[subjectType] || sessionTypes.theory;
            
            // Calculate how many sessions we need
            let sessionsNeeded = Math.ceil(remainingHours / currentType.duration);
            
            // For lab/practical subjects, ensure we don't exceed reasonable session count
            if (subjectType === 'lab' || subjectType === 'practical') {
                // Labs typically have 2-3 sessions per week max
                sessionsNeeded = Math.min(sessionsNeeded, 3);
                
                // Create lab sessions
                for (let i = 0; i < sessionsNeeded && remainingHours > 0; i++) {
                    const sessionHours = Math.min(currentType.duration, remainingHours);
                    lectures.push({
                        subjectCode,
                        subjectName,
                        facultyCode,
                        facultyName,
                        lectureType: subjectType,
                        hours: sessionHours,
                        sessionId: `${subjectCode}_${subjectType}_${i + 1}`
                    });
                    remainingHours -= sessionHours;
                }
            } else {
                // For theory subjects, create 1-hour sessions
                for (let i = 0; i < remainingHours; i++) {
                    lectures.push({
                        subjectCode,
                        subjectName,
                        facultyCode,
                        facultyName,
                        lectureType: 'theory',
                        hours: 1,
                        sessionId: `${subjectCode}_theory_${i + 1}`
                    });
                }
            }
            
            return lectures;
        }

        // Check faculty daily constraints (max 1 theory + 1 lab per day)
        function checkFacultyDailyConstraints(facultyCode, day, lectureType, facultyDailySchedule) {
            if (!facultyDailySchedule[facultyCode]) {
                facultyDailySchedule[facultyCode] = {};
            }
            
            if (!facultyDailySchedule[facultyCode][day]) {
                facultyDailySchedule[facultyCode][day] = {
                    theory: 0,
                    lab: 0,
                    practical: 0
                };
            }
            
            const daySchedule = facultyDailySchedule[facultyCode][day];
            
            // Check constraints
            if (lectureType === 'theory' && daySchedule.theory >= 1) {
                return false; // Already has 1 theory lecture
            }
            
            if ((lectureType === 'lab' || lectureType === 'practical') && 
                (daySchedule.lab + daySchedule.practical) >= 1) {
                return false; // Already has 1 lab/practical session
            }
            
            return true;
        }

        // Update faculty daily schedule
        function updateFacultyDailySchedule(facultyCode, day, lectureType, facultyDailySchedule) {
            if (!facultyDailySchedule[facultyCode]) {
                facultyDailySchedule[facultyCode] = {};
            }
            
            if (!facultyDailySchedule[facultyCode][day]) {
                facultyDailySchedule[facultyCode][day] = {
                    theory: 0,
                    lab: 0,
                    practical: 0
                };
            }
            
            facultyDailySchedule[facultyCode][day][lectureType]++;
        }
        function checkDailyHourLimitViolation(facultyCode, globalFacultyDailyHours, localFacultyDailyHours, limit) {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            for (const day of days) {
                const globalHours = (globalFacultyDailyHours[facultyCode] && 
                                   globalFacultyDailyHours[facultyCode][day]) || 0;
                const localHours = localFacultyDailyHours[facultyCode][day] || 0;
                const totalHours = globalHours + localHours;
                
                if (totalHours > limit) {
                    return {
                        violation: true,
                        day: day,
                        totalHours: totalHours
                    };
                }
            }
            
            return { violation: false };
        }

        // Helper function to validate final faculty hours
        function validateFinalFacultyHours(localFacultyDailyHours, globalFacultyDailyHours, limit, lectures) {
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            for (const facultyCode of Object.keys(localFacultyDailyHours)) {
                const facultyInfo = lectures.find(l => l.facultyCode === facultyCode);
                const facultyName = facultyInfo ? facultyInfo.facultyName : facultyCode;
                
                for (const day of days) {
                    const globalHours = (globalFacultyDailyHours[facultyCode] && 
                                       globalFacultyDailyHours[facultyCode][day]) || 0;
                    const localHours = localFacultyDailyHours[facultyCode][day] || 0;
                    const totalHours = globalHours + localHours;
                    
                    if (totalHours > limit) {
                        return {
                            valid: false,
                            error: `Faculty ${facultyName} exceeds daily teaching limit of ${limit} hours on ${day}. Total assigned: ${totalHours} hours.`,
                            facultyCode: facultyCode,
                            facultyName: facultyName,
                            day: day,
                            totalHours: totalHours
                        };
                    }
                }
            }
            
            return { valid: true };
        }

        function assignRoom(lectureType) {
            const rooms = {
                theory: ['T1', 'T2', 'T3', 'LT01', 'LT02', 'LT03'],
                lab: ['Lab1', 'Lab2', 'Lab3', 'CS-Lab', 'ECE-Lab'],
                practical: ['Workshop-A', 'Workshop-B', 'Practical-Lab'],
                tutorial: ['T4', 'T5', 'Tutorial-Room']
            };
            
            const availableRooms = rooms[lectureType] || rooms.theory;
            return availableRooms[Math.floor(Math.random() * availableRooms.length)];
        }

        function proceedToPreview() {
            if (Object.keys(generatedTimetables).length === 0) {
                alert('No timetables generated. Please go back and generate first.');
                return;
            }

            updateWorkflowStep(5);
            showStep(5);
            displayAllTimetablePreviews();
        }

        // Step 5: Preview All Timetables
        function displayAllTimetablePreviews() {
            const previewContainer = document.getElementById('timetablePreview');
            previewContainer.innerHTML = '';
            
            Object.keys(generatedTimetables).forEach(key => {
                const data = generatedTimetables[key];
                const [semesterId, section] = key.split('-');
                
                const timetableDiv = document.createElement('div');
                timetableDiv.className = 'course-group';
                timetableDiv.innerHTML = `
                    <div class="course-group-header">
                        <span><i class="fas fa-table"></i> ${data.semester.name} - Section ${section}</span>
                        <div style="display: flex; gap: 10px;">
                            <span style="font-size: 0.9rem;">${data.lectures.length} lectures scheduled</span>
                            <button class="control-btn" onclick="editTimetable('${key}')" title="Edit Timetable">
                                <i class="fas fa-edit"></i> Edit
                            </button>
                            <button class="control-btn" onclick="saveTimetable('${key}')" title="Save Timetable">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="control-btn" onclick="downloadTimetablePDF('${key}')" title="Download PDF">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button class="control-btn" onclick="openPDFInterfaceForTimetable('${key}')" title="Advanced PDF Options">
                                <i class="fas fa-cogs"></i> PDF Options
                            </button>
                        </div>
                    </div>
                    <div class="course-group-content">
                        ${renderTimetableHTML(data.timetable, key)}
                        
                        <!-- Edit Mode Container (Initially Hidden) -->
                        <div class="edit-mode-container" id="edit-${key}" style="display: none;">
                            <div style="background: #fff3cd; border: 1px solid #ffeaa7; border-radius: 8px; padding: 15px; margin: 15px 0;">
                                <h4 style="color: #856404; margin-bottom: 10px;">
                                    <i class="fas fa-edit"></i> Edit Mode: ${data.semester.name} - Section ${section}
                                </h4>
                                <p style="color: #856404; font-size: 0.9rem;">Click on any time slot to modify the assignment. Empty slots can be filled with new lectures.</p>
                            </div>
                            
                            <div class="edit-controls" style="margin-bottom: 15px;">
                                <button class="control-btn" onclick="addNewLectureSlot('${key}')">
                                    <i class="fas fa-plus"></i> Add New Lecture
                                </button>
                                <button class="control-btn secondary" onclick="cancelEdit('${key}')">
                                    <i class="fas fa-times"></i> Cancel
                                </button>
                                <button class="control-btn" onclick="saveEditedTimetable('${key}')">
                                    <i class="fas fa-check"></i> Save Changes
                                </button>
                            </div>
                            
                            ${renderEditableTimetableHTML(data.timetable, key)}
                        </div>
                    </div>
                `;
                
                previewContainer.appendChild(timetableDiv);
            });
        }

        // Edit Functionality
        function editTimetable(key) {
            const editContainer = document.getElementById(`edit-${key}`);
            const normalView = editContainer.previousElementSibling;
            
            // Toggle edit mode
            if (editContainer.style.display === 'none') {
                editContainer.style.display = 'block';
                normalView.style.display = 'none';
            } else {
                editContainer.style.display = 'none';
                normalView.style.display = 'block';
            }
        }

        function renderEditableTimetableHTML(timetable, key) {
            const currentTimeSlots = timeSlots.map(slot => slot.display);
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            let html = `
                <div class="timetable-container">
                    <table class="timetable-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Monday</th>
                                <th>Tuesday</th>
                                <th>Wednesday</th>
                                <th>Thursday</th>
                                <th>Friday</th>
                                <th>Saturday</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            currentTimeSlots.forEach((timeSlot, timeIndex) => {
                html += `<tr><td>${timeSlot}</td>`;
                
                days.forEach(day => {
                    const classInfo = timetable[day][timeIndex];
                    const cellId = `edit-cell-${key}-${day}-${timeIndex}`;
                    
                    if (classInfo && classInfo.type === 'lunch') {
                        html += `<td style="background: #fff5f5; color: #742a2a; font-weight: 600;">${classInfo.content}</td>`;
                    } else {
                        html += `
                            <td id="${cellId}" style="padding: 8px; cursor: pointer; min-height: 80px; position: relative; ${classInfo ? 'background: #e6fffa; border-left: 4px solid #38b2ac;' : 'background: #f8f9fa; border: 2px dashed #dee2e6;'}" 
                                onclick="editTimeSlot('${key}', '${day}', ${timeIndex})" 
                                onmouseover="this.style.backgroundColor='#edf2f7'" 
                                onmouseout="this.style.backgroundColor='${classInfo ? '#e6fffa' : '#f8f9fa'}'">
                                ${classInfo ? `
                                    <div style="font-weight: bold; color: #2d3748; font-size: 0.85rem;">${classInfo.subjectCode}</div>
                                    <div style="font-size: 0.75rem; color: #4a5568; margin: 2px 0;">${classInfo.subjectName}</div>
                                    <div style="font-size: 0.75rem; color: #718096;">${classInfo.facultyCode}</div>
                                    <div style="font-size: 0.7rem; background: ${classInfo.lectureType === 'lab' ? '#ed8936' : '#4299e1'}; color: white; padding: 2px 6px; border-radius: 3px; margin-top: 3px; display: inline-block;">${classInfo.lectureType.toUpperCase()}</div>
                                    <div style="font-size: 0.7rem; color: #666; margin-top: 2px;">${classInfo.room}</div>
                                    <button style="position: absolute; top: 2px; right: 2px; background: #f56565; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 0.7rem; cursor: pointer;" onclick="event.stopPropagation(); clearTimeSlot('${key}', '${day}', ${timeIndex})"></button>
                                ` : `
                                    <div style="color: #a0aec0; font-size: 0.8rem;">
                                        <i class="fas fa-plus"></i><br>Add Lecture
                                    </div>
                                `}
                            </td>
                        `;
                    }
                });
                
                html += `</tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }

        function editTimeSlot(key, day, timeIndex) {
            const data = generatedTimetables[key];
            const currentClass = data.timetable[day][timeIndex];
            
            // Create edit modal
            const modal = document.createElement('div');
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                background: rgba(0,0,0,0.5); z-index: 1000; display: flex; 
                align-items: center; justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h3 style="margin-bottom: 20px; color: #4a5568;">
                        <i class="fas fa-edit"></i> Edit Time Slot: ${day} ${timeSlots[timeIndex].display}
                    </h3>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Lecture Type:</label>
                        <select id="editLectureType" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px;">
                            <option value="">Select Type</option>
                            <option value="theory" ${currentClass && currentClass.lectureType === 'theory' ? 'selected' : ''}>Theory</option>
                            <option value="lab" ${currentClass && currentClass.lectureType === 'lab' ? 'selected' : ''}>LAB</option>
                            <option value="practical" ${currentClass && currentClass.lectureType === 'practical' ? 'selected' : ''}>Practical</option>
                            <option value="tutorial" ${currentClass && currentClass.lectureType === 'tutorial' ? 'selected' : ''}>Tutorial</option>
                        </select>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Subject Code:</label>
                        <input type="text" id="editSubjectCode" placeholder="e.g., CS701" value="${currentClass ? currentClass.subjectCode : ''}" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Subject Name:</label>
                        <input type="text" id="editSubjectName" placeholder="e.g., Machine Learning" value="${currentClass ? currentClass.subjectName : ''}" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Faculty Code:</label>
                        <input type="text" id="editFacultyCode" placeholder="e.g., DR.SM" value="${currentClass ? currentClass.facultyCode : ''}" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Faculty Name:</label>
                        <input type="text" id="editFacultyName" placeholder="e.g., Dr. Smith" value="${currentClass ? currentClass.facultyName : ''}" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px;">
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <label style="display: block; margin-bottom: 5px; font-weight: 600;">Room:</label>
                        <input type="text" id="editRoom" placeholder="e.g., T1, Lab1" value="${currentClass ? currentClass.room : ''}" style="width: 100%; padding: 8px; border: 2px solid #e2e8f0; border-radius: 6px;">
                    </div>
                    
                    <div style="display: flex; gap: 10px; justify-content: flex-end;">
                        <button onclick="closeEditModal()" style="padding: 10px 20px; background: #718096; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Cancel
                        </button>
                        <button onclick="saveTimeSlotEdit('${key}', '${day}', ${timeIndex})" style="padding: 10px 20px; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer;">
                            Save Changes
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            modal.onclick = (e) => {
                if (e.target === modal) closeEditModal();
            };
        }

        function saveTimeSlotEdit(key, day, timeIndex) {
            const lectureType = document.getElementById('editLectureType').value;
            const subjectCode = document.getElementById('editSubjectCode').value.trim();
            const subjectName = document.getElementById('editSubjectName').value.trim();
            const facultyCode = document.getElementById('editFacultyCode').value.trim();
            const facultyName = document.getElementById('editFacultyName').value.trim();
            const room = document.getElementById('editRoom').value.trim();
            
            if (lectureType && subjectCode && subjectName && facultyCode && facultyName && room) {
                // Update the timetable data
                generatedTimetables[key].timetable[day][timeIndex] = {
                    lectureType,
                    subjectCode,
                    subjectName,
                    facultyCode,
                    facultyName,
                    room
                };
                
                // Refresh the editable view
                const editContainer = document.getElementById(`edit-${key}`);
                const editableTable = editContainer.querySelector('div[style*="overflow-x"]');
                editableTable.outerHTML = renderEditableTimetableHTML(generatedTimetables[key].timetable, key);
                
                closeEditModal();
                showStatus('previewStatus', 'Time slot updated successfully!', 'success');
            } else {
                alert('Please fill in all fields to save the time slot.');
            }
        }

        function clearTimeSlot(key, day, timeIndex) {
            if (confirm('Are you sure you want to clear this time slot?')) {
                generatedTimetables[key].timetable[day][timeIndex] = null;
                
                // Refresh the editable view
                const editContainer = document.getElementById(`edit-${key}`);
                const editableTable = editContainer.querySelector('div[style*="overflow-x"]');
                editableTable.outerHTML = renderEditableTimetableHTML(generatedTimetables[key].timetable, key);
                
                showStatus('previewStatus', 'Time slot cleared successfully!', 'success');
            }
        }

        function closeEditModal() {
            const modal = document.querySelector('div[style*="position: fixed"]');
            if (modal) {
                document.body.removeChild(modal);
            }
        }

        function cancelEdit(key) {
            const editContainer = document.getElementById(`edit-${key}`);
            const normalView = editContainer.previousElementSibling;
            
            editContainer.style.display = 'none';
            normalView.style.display = 'block';
        }

        function saveEditedTimetable(key) {
            // Here you would save the edited timetable to the server
            const data = generatedTimetables[key];
            
            // Simulate API call
            setTimeout(() => {
                showStatus('previewStatus', `Edited timetable saved for ${data.semester.name} - Section ${data.section}!`, 'success');
                cancelEdit(key);
            }, 1000);
        }

        // Save Functionality
        async function saveTimetable(key) {
            const data = generatedTimetables[key];
            
            try {
                // Prepare data for saving
                const timetableData = {
                    id: key,
                    semester: data.semester.name,
                    section: data.section,
                    lectures: data.lectures,
                    timetable: data.timetable,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };

                // Save to localStorage for demo purposes
                let savedTimetables = JSON.parse(localStorage.getItem('savedTimetables') || '[]');
                
                // Remove existing entry if it exists
                savedTimetables = savedTimetables.filter(t => t.id !== key);
                
                // Add new entry
                savedTimetables.push(timetableData);
                
                // Save to localStorage
                localStorage.setItem('savedTimetables', JSON.stringify(savedTimetables));
                
                showStatus('previewStatus', `Timetable saved successfully for ${data.semester.name} - Section ${data.section}!`, 'success');
                
            } catch (error) {
                console.error('Save error:', error);
                showStatus('previewStatus', `Failed to save timetable for ${data.semester.name} - Section ${data.section}. Please try again.`, 'error');
            }
        }

        // Download PDF Functionality
        async function downloadTimetablePDF(key) {
            const data = generatedTimetables[key];
            
            try {
                showStatus('previewStatus', `Generating PDF for ${data.semester.name} - Section ${data.section}...`, 'info');
                
                // Generate PDF using jsPDF
                const pdf = generatePDFDocument(data);
                
                // Download the PDF
                const fileName = `${data.semester.name.replace(/\s+/g, '_')}_Section_${data.section}_${Date.now()}.pdf`;
                pdf.save(fileName);
                
                showStatus('previewStatus', `PDF downloaded successfully for ${data.semester.name} - Section ${data.section}!`, 'success');
                
            } catch (error) {
                console.error('PDF generation error:', error);
                showStatus('previewStatus', `Failed to generate PDF for ${data.semester.name} - Section ${data.section}. Please try again.`, 'error');
            }
        }

        // Generate PDF document using jsPDF
        function generatePDFDocument(data) {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('landscape', 'mm', 'a4');
            
            // Set up document properties
            pdf.setProperties({
                title: `${data.semester.name} - Section ${data.section} - Timetable`,
                subject: 'College Timetable',
                author: 'Multi-Semester Smart Generator',
                creator: 'Timetable Generator System'
            });
            
            // Add header
            addPDFHeader(pdf, data);
            
            // Add timetable
            addTimetableTable(pdf, data);
            
            // Add new page for subject details
            pdf.addPage();
            addSubjectDetailsTable(pdf, data);
            
            return pdf;
        }

        // Add header to PDF
        function addPDFHeader(pdf, data) {
            // Institution name
            pdf.setFontSize(20);
            pdf.setFont('helvetica', 'bold');
            pdf.text('EDUCATIONAL INSTITUTION', pdf.internal.pageSize.getWidth() / 2, 20, { align: 'center' });
            
            // Timetable title
            pdf.setFontSize(16);
            pdf.text(`${data.semester.name} - Section ${data.section}`, pdf.internal.pageSize.getWidth() / 2, 30, { align: 'center' });
            
            // Generation date
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Generated on: ${new Date().toLocaleDateString()}`, pdf.internal.pageSize.getWidth() / 2, 38, { align: 'center' });
            
            // Academic year (optional)
            pdf.text(`Academic Year: ${new Date().getFullYear()}-${new Date().getFullYear() + 1}`, pdf.internal.pageSize.getWidth() / 2, 44, { align: 'center' });
        }

        // Add timetable table to PDF
        function addTimetableTable(pdf, data) {
            const currentTimeSlots = timeSlots.map(slot => slot.display);
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            // Prepare table data
            const tableData = [];
            
            currentTimeSlots.forEach((timeSlot, timeIndex) => {
                const row = [timeSlot];
                
                days.forEach(day => {
                    const classInfo = data.timetable[day][timeIndex];
                    
                    if (classInfo) {
                        if (classInfo.type === 'lunch') {
                            row.push('LUNCH BREAK');
                        } else {
                            const cellContent = `${classInfo.subjectCode}\n${classInfo.subjectName}\n${classInfo.facultyCode}\n${classInfo.room}\n[${classInfo.lectureType.toUpperCase()}]`;
                            row.push(cellContent);
                        }
                    } else {
                        row.push('');
                    }
                });
                
                tableData.push(row);
            });
            
            // Create table
            pdf.autoTable({
                head: [['Time', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']],
                body: tableData,
                startY: 55,
                theme: 'grid',
                headStyles: {
                    fillColor: [102, 126, 234],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 10,
                    halign: 'center'
                },
                bodyStyles: {
                    fontSize: 8,
                    cellPadding: 3,
                    valign: 'middle',
                    halign: 'center'
                },
                columnStyles: {
                    0: { 
                        fillColor: [74, 85, 104],
                        textColor: [255, 255, 255],
                        fontStyle: 'bold',
                        halign: 'center'
                    }
                },
                didParseCell: function(data) {
                    // Color lunch break cells
                    if (data.cell.text[0] === 'LUNCH BREAK') {
                        data.cell.styles.fillColor = [255, 245, 245];
                        data.cell.styles.textColor = [116, 42, 42];
                        data.cell.styles.fontStyle = 'bold';
                    }
                    // Color subject cells
                    else if (data.cell.text[0] && data.cell.text[0] !== '' && data.section === 'body' && data.column.index > 0) {
                        data.cell.styles.fillColor = [230, 255, 250];
                        data.cell.styles.textColor = [45, 55, 72];
                    }
                },
                margin: { top: 55, left: 10, right: 10 },
                tableWidth: 'auto',
                styles: {
                    overflow: 'linebreak',
                    cellWidth: 'wrap'
                }
            });
        }

        // Add subject details table to PDF
        function addSubjectDetailsTable(pdf, data) {
            // Add title for subject details
            pdf.setFontSize(16);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Subject Details', 20, 30);
            
            // Prepare subject data
            const subjectData = data.lectures.map(lecture => [
                lecture.subjectCode,
                lecture.subjectName,
                `${lecture.facultyName}\n(${lecture.facultyCode})`,
                lecture.lectureType.toUpperCase(),
                lecture.hoursPerWeek.toString()
            ]);
            
            // Create subject details table
            pdf.autoTable({
                head: [['Subject Code', 'Subject Name', 'Faculty', 'Type', 'Hours/Week']],
                body: subjectData,
                startY: 40,
                theme: 'striped',
                headStyles: {
                    fillColor: [66, 153, 225],
                    textColor: [255, 255, 255],
                    fontStyle: 'bold',
                    fontSize: 11,
                    halign: 'center'
                },
                bodyStyles: {
                    fontSize: 10,
                    cellPadding: 5,
                    valign: 'middle'
                },
                columnStyles: {
                    0: { halign: 'center', cellWidth: 30 },
                    1: { halign: 'left', cellWidth: 60 },
                    2: { halign: 'center', cellWidth: 50 },
                    3: { halign: 'center', cellWidth: 25 },
                    4: { halign: 'center', cellWidth: 25 }
                },
                margin: { top: 40, left: 20, right: 20 }
            });
            
            // Add summary statistics
            const finalY = pdf.lastAutoTable.finalY + 20;
            
            pdf.setFontSize(12);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Summary Statistics:', 20, finalY);
            
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            
            const totalSubjects = data.lectures.length;
            const totalHours = data.lectures.reduce((sum, lecture) => sum + lecture.hoursPerWeek, 0);
            const theorySubjects = data.lectures.filter(l => l.lectureType === 'theory').length;
            const labSubjects = data.lectures.filter(l => l.lectureType === 'lab').length;
            const practicalSubjects = data.lectures.filter(l => l.lectureType === 'practical').length;
            const tutorialSubjects = data.lectures.filter(l => l.lectureType === 'tutorial').length;
            
            const stats = [
                `Total Subjects: ${totalSubjects}`,
                `Total Hours per Week: ${totalHours}`,
                `Theory Subjects: ${theorySubjects}`,
                `Lab Subjects: ${labSubjects}`,
                `Practical Subjects: ${practicalSubjects}`,
                `Tutorial Subjects: ${tutorialSubjects}`
            ];
            
            stats.forEach((stat, index) => {
                pdf.text(stat, 20, finalY + 10 + (index * 6));
            });
            
            // Add footer
            const pageHeight = pdf.internal.pageSize.getHeight();
            pdf.setFontSize(8);
            pdf.setFont('helvetica', 'italic');
            pdf.text('Generated by Multi-Semester Smart Timetable Generator', pdf.internal.pageSize.getWidth() / 2, pageHeight - 10, { align: 'center' });
        }

        function renderTimetableHTML(timetable, key = '') {
            const currentTimeSlots = timeSlots.map(slot => slot.display);
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
            
            let html = `
                <div class="timetable-container">
                    <table class="timetable-table">
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Monday</th>
                                <th>Tuesday</th>
                                <th>Wednesday</th>
                                <th>Thursday</th>
                                <th>Friday</th>
                                <th>Saturday</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            currentTimeSlots.forEach((timeSlot, timeIndex) => {
                html += `<tr><td>${timeSlot}</td>`;
                
                days.forEach(day => {
                    const classInfo = timetable[day][timeIndex];
                    
                    if (classInfo) {
                        if (classInfo.type === 'lunch') {
                            html += `<td style="background: #fff5f5; color: #742a2a; font-weight: 600;">${classInfo.content}</td>`;
                        } else {
                            html += `
                                <td style="background: #e6fffa; border-left: 4px solid #38b2ac; padding: 8px;">
                                    <div style="font-weight: bold; color: #2d3748; font-size: 0.85rem;">${classInfo.subjectCode}</div>
                                    <div style="font-size: 0.75rem; color: #4a5568; margin: 2px 0;">${classInfo.subjectName}</div>
                                    <div style="font-size: 0.75rem; color: #718096;">${classInfo.facultyCode}</div>
                                    <div style="font-size: 0.7rem; background: ${classInfo.lectureType === 'lab' ? '#ed8936' : '#4299e1'}; color: white; padding: 2px 6px; border-radius: 3px; margin-top: 3px; display: inline-block;">${classInfo.lectureType.toUpperCase()}</div>
                                    <div style="font-size: 0.7rem; color: #666; margin-top: 2px;">${classInfo.room}</div>
                                </td>
                            `;
                        }
                    } else {
                        html += `<td></td>`;
                    }
                });
                
                html += `</tr>`;
            });
            
            html += `
                        </tbody>
                    </table>
                </div>
            `;
            
            return html;
        }

        // Utility Functions
        function showStep(stepNumber) {
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`step${stepNumber}`).classList.add('active');
            currentStep = stepNumber;
        }

        function updateWorkflowStep(stepNumber) {
            for (let i = 0; i <= 5; i++) {
                const circle = document.getElementById(`step${i}Circle`);
                if (circle) {
                    circle.classList.remove('active', 'completed');
                    
                    if (i < stepNumber) {
                        circle.classList.add('completed');
                        circle.innerHTML = '<i class="fas fa-check"></i>';
                    } else if (i === stepNumber) {
                        circle.classList.add('active');
                        circle.innerHTML = i;
                    } else {
                        circle.innerHTML = i;
                    }
                }
            }
        }

        function goBackToStep(stepNumber) {
            updateWorkflowStep(stepNumber);
            showStep(stepNumber);
        }

        function showStatus(elementId, message, type) {
            const statusDiv = document.getElementById(elementId);
            statusDiv.className = `status-message ${type}`;
            statusDiv.textContent = message;
        }

        function resetWorkflow() {
            currentStep = 0;
            selectedSemesters = [];
            sectionConfigurations = {};
            lectureConfigurations = {};
            generatedTimetables = {};
            
            updateWorkflowStep(0);
            showStep(0);
            initializeWorkingHours();
            
            // Reset buttons
            document.getElementById('proceedToSectionBtn').disabled = true;
            document.getElementById('proceedToLectureBtn').disabled = true;
            document.getElementById('proceedToPreviewBtn').disabled = false;
        }

        // PDF Download Interface Integration
        function openPDFDownloadInterface() {
            if (Object.keys(generatedTimetables).length === 0) {
                showStatus('previewStatus', 'No timetables generated. Please generate timetables first.', 'error');
                return;
            }

            // Prepare data for PDF interface
            const pdfData = {
                multiSemesterData: true,
                selectedSemesters: selectedSemesters,
                sectionConfigurations: sectionConfigurations,
                generatedTimetables: generatedTimetables,
                totalTimetables: Object.keys(generatedTimetables).length
            };

            // Store data in localStorage for the PDF interface
            localStorage.setItem('multiSemesterPDFData', JSON.stringify(pdfData));
            
            // Open PDF download interface in new window/tab
            const pdfWindow = window.open('pdf_download_interface.html', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            if (!pdfWindow) {
                // Fallback if popup blocked
                if (confirm('Popup blocked. Would you like to navigate to the PDF download interface?')) {
                    window.location.href = 'pdf_download_interface.html';
                }
            } else {
                showStatus('previewStatus', 'PDF download interface opened in new window.', 'success');
            }
        }

        // Enhanced PDF download for individual timetables
        async function downloadTimetablePDF(key) {
            const data = generatedTimetables[key];
            
            try {
                // Prepare data for PDF generation
                const pdfData = {
                    semester: data.semester.name,
                    section: data.section,
                    subjects: data.lectures,
                    timetable: data.timetable,
                    format: 'standard', // Default format
                    colorScheme: 'default', // Default color scheme
                    includeSubjectList: true,
                    includeFacultyInfo: true,
                    includeStatistics: true,
                    includeHeader: true,
                    institutionName: 'Educational Institution'
                };

                const response = await fetch('/api/timetables/download/pdf', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(pdfData)
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${data.semester.name.replace(/\s+/g, '_')}_Section_${data.section}_${Date.now()}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                    
                    showStatus('previewStatus', `PDF downloaded for ${data.semester.name} - Section ${data.section}!`, 'success');
                } else {
                    throw new Error('Failed to generate PDF');
                }
            } catch (error) {
                console.error('PDF download error:', error);
                showStatus('previewStatus', `Failed to download PDF for ${data.semester.name} - Section ${data.section}. Please try again.`, 'error');
            }
        }

        // Open PDF interface for individual timetable
        function openPDFInterfaceForTimetable(key) {
            const data = generatedTimetables[key];
            
            // Prepare single timetable data for PDF interface
            const pdfData = {
                multiSemesterData: false,
                singleTimetableMode: true,
                currentTimetable: {
                    key: key,
                    semester: data.semester.name,
                    section: data.section,
                    subjects: data.lectures,
                    timetable: data.timetable,
                    semesterInfo: data.semester
                }
            };

            // Store data in localStorage for the PDF interface
            localStorage.setItem('singleTimetablePDFData', JSON.stringify(pdfData));
            
            // Open PDF download interface in new window/tab
            const pdfWindow = window.open('pdf_download_interface.html', '_blank', 'width=1200,height=800,scrollbars=yes,resizable=yes');
            
            if (!pdfWindow) {
                // Fallback if popup blocked
                if (confirm('Popup blocked. Would you like to navigate to the PDF download interface?')) {
                    window.location.href = 'pdf_download_interface.html';
                }
            } else {
                showStatus('previewStatus', `PDF options opened for ${data.semester.name} - Section ${data.section}`, 'success');
            }
        }
    </script>
</body>
</html>
